<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>ChatApp - SignalR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }

        .message {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h2>ChatApp (SignalR Local)</h2>

    <input id="usernameInput" placeholder="Username" value="Alice" />
    <input id="messageInput" placeholder="Type message..." />
    <button onclick="sendMessage()">Send</button>

    <div id="messages"></div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveMessage", function (data) {
            addMessage(data);
        });

        connection.start()
            .then(() => {
                console.log("Connected to SignalR");
                loadMessages();
            })
            .catch(err => console.error(err));

        async function sendMessage() {
            const username = document.getElementById('usernameInput').value;
            const message = document.getElementById('messageInput').value;

            if (!username || !message.trim()) return;

            try {
                await connection.invoke("SendMessage", username, message);
                document.getElementById('messageInput').value = '';
            } catch (err) {
                console.error(err);
            }
        }

        async function loadMessages() {
            try {
                const res = await fetch("/api/chat/messages");
                if (!res.ok) throw new Error("Failed to fetch messages");
                const data = await res.json();

                document.getElementById('messages').innerHTML = '';
                data.forEach(addMessage);
            } catch (err) {
                console.error("Error loading messages:", err);
            }
        }

        function addMessage(data) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<b>${data.username}</b>: ${data.message}
          <span style="color:gray;">(${new Date(data.timestamp).toLocaleTimeString()})</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
